name: Build Luanti for Raspberry Pi 5 (Static)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bullseye

    steps:
    - name: Install build dependencies
      run: |
        apt-get update
        apt-get install -y --no-install-recommends \
          ca-certificates \
          g++-aarch64-linux-gnu \
          gcc-aarch64-linux-gnu \
          cmake \
          make \
          git \
          wget \
          build-essential \
          libx11-dev:arm64 \
          libxxf86vm-dev:arm64 \
          libgl1-mesa-dev:arm64 \
          libglu1-mesa-dev:arm64 \
          pkg-config \
          xz-utils

    - name: Create aarch64 toolchain file
      run: |
        mkdir -p luanti/cmake/toolchains
        cat > luanti/cmake/toolchains/aarch64-linux-gnu.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR aarch64)
        set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
        set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
        set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu $GITHUB_WORKSPACE/deps/install)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_LIBRARY_ARCHITECTURE aarch64-linux-gnu)
        EOF

    - name: Install cross-compilation libraries
      run: |
        # Install tools for creating symlinks
        apt-get install -y symlinks
        
        # Create a sysroot directory for cross-compilation
        mkdir -p /sysroot/usr/lib/aarch64-linux-gnu
        mkdir -p /sysroot/usr/include
        
        # Symlink host libraries to sysroot (this is a workaround)
        ln -s /usr/include/GL /sysroot/usr/include/GL
        ln -s /usr/include/X11 /sysroot/usr/include/X11
        ln -s /usr/include/aarch64-linux-gnu /sysroot/usr/include/aarch64-linux-gnu
        ln -s /usr/lib/aarch64-linux-gnu /sysroot/usr/lib/aarch64-linux-gnu
        
        # For GLES headers if needed
        ln -s /usr/include/GLES* /sysroot/usr/include/ || true

    - name: Update toolchain file for OpenGL
      run: |
        cat >> toolchains/aarch64-linux-gnu.cmake <<'EOF'
        
        # OpenGL paths
        set(OPENGL_INCLUDE_DIR /sysroot/usr/include)
        set(OPENGL_gl_LIBRARY /sysroot/usr/lib/aarch64-linux-gnu/libGL.so)
        set(OPENGL_glu_LIBRARY /sysroot/usr/lib/aarch64-linux-gnu/libGLU.so)
        set(OPENGL_glx_LIBRARY /sysroot/usr/lib/aarch64-linux-gnu/libGLX.so)
        EOF

    - name: Checkout Luanti source
      uses: actions/checkout@v4
      with:
        path: luanti
        submodules: recursive

    - name: Create directories for dependencies
      run: |
        mkdir -p deps/build deps/install

    - name: Build zlib
      run: |
        cd deps
        wget -4 https://www.zlib.net/zlib-1.3.1.tar.gz
        tar xf zlib-1.3.1.tar.gz
        cd zlib-1.3.1
        CHOST=aarch64-linux-gnu ./configure --static --prefix=$PWD/../../deps/install
        make
        make install

    - name: Build SQLite3
      run: |
        cd deps
        wget -4 https://www.sqlite.org/2023/sqlite-autoconf-3430200.tar.gz
        tar xf sqlite-autoconf-3430200.tar.gz
        cd sqlite-autoconf-3430200
        ./configure --host=aarch64-linux-gnu --disable-shared --enable-static --prefix=$PWD/../../deps/install
        make
        make install

    - name: Build LuaJIT
      run: |
        cd deps
        git clone https://github.com/LuaJIT/LuaJIT.git
        cd luajit
        make HOST_CC="gcc" CROSS="aarch64-linux-gnu-" BUILDMODE="static" PREFIX=$PWD/../../deps/install -j$(nproc)
        make install PREFIX=$PWD/../../deps/install

    - name: Build cURL
      run: |
        cd deps
        wget -4 https://curl.se/download/curl-8.4.0.tar.gz
        tar xf curl-8.4.0.tar.gz
        cd curl-8.4.0
        ./configure --host=aarch64-linux-gnu --disable-shared --enable-static --prefix=$PWD/../../deps/install \
          --with-zlib=$PWD/../../deps/install --without-ssl
        make
        make install

    - name: Build Freetype
      run: |
        cd deps
        wget -4 https://download.savannah.gnu.org/releases/freetype/freetype-2.13.2.tar.gz
        tar xf freetype-2.13.2.tar.gz
        cd freetype-2.13.2
        ./configure --host=aarch64-linux-gnu --disable-shared --enable-static --prefix=$PWD/../../deps/install --with-zlib=no
        make
        make install

    - name: Build OpenAL-Soft
      run: |
        cd deps
        git clone https://github.com/kcat/openal-soft.git
        cd openal-soft/build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/luanti/cmake/toolchains/aarch64-linux-gnu.cmake \
          -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/deps/install \
          -DLIBTYPE=STATIC \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
        make
        make install

    - name: Build Ogg
      run: |
        cd deps
        wget -4 https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz
        tar xf libogg-1.3.5.tar.gz
        cd libogg-1.3.5
        ./configure --host=aarch64-linux-gnu --disable-shared --enable-static --prefix=$PWD/../../deps/install
        make
        make install

    - name: Build libvorbis
      run: |
        cd deps
        wget -4 https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.7.tar.gz
        tar xf libvorbis-1.3.7.tar.gz
        cd libvorbis-1.3.7
        ./configure --host=aarch64-linux-gnu --disable-shared --enable-static --prefix=$PWD/../../deps/install \
          --with-ogg=$PWD/../../deps/install
        make
        make install

    - name: Build GMP
      run: |
        cd deps
        wget -4 https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz
        tar xf gmp-6.3.0.tar.xz
        cd gmp-6.3.0
        ./configure --host=aarch64-linux-gnu --disable-shared --enable-static --prefix=$PWD/../../deps/install
        make
        make install

    - name: Build json-c
      run: |
        cd deps
        git clone https://github.com/json-c/json-c.git
        cd json-c
        cmake . -DCMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/luanti/cmake/toolchains/aarch64-linux-gnu.cmake \
          -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/deps/install \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
        make
        make install

    - name: Build zstd
      run: |
        cd deps
        wget -4 https://github.com/facebook/zstd/releases/download/v1.5.5/zstd-1.5.5.tar.gz
        tar xf zstd-1.5.5.tar.gz
        cd zstd-1.5.5/build/cmake
        cmake . -DCMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/luanti/cmake/toolchains/aarch64-linux-gnu.cmake \
          -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/deps/install \
          -DZSTD_BUILD_STATIC=ON -DZSTD_BUILD_SHARED=OFF \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
        make
        make install
        
    - name: Build IrrlichtMt (with OpenGL support)
      run: |
        cd deps
        git clone --depth 1 https://github.com/minetest/irrlicht.git
        cd irrlicht
        mkdir build && cd build
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE \
          -DCMAKE_INSTALL_PREFIX=$DEPS_INSTALL_DIR \
          -DCMAKE_FIND_ROOT_PATH=$DEPS_INSTALL_DIR \
          -DBUILD_SHARED_LIBS=OFF \
          -DIRRLICHT_BUILD_STATIC=ON \
          -DZLIB_LIBRARY=$DEPS_INSTALL_DIR/lib/libz.a \
          -DZLIB_INCLUDE_DIR=$DEPS_INSTALL_DIR/include \
          -DJPEG_LIBRARY=$DEPS_INSTALL_DIR/lib/libjpeg.a \
          -DJPEG_INCLUDE_DIR=$DEPS_INSTALL_DIR/include \
          -DPNG_LIBRARY=$DEPS_INSTALL_DIR/lib/libpng.a \
          -DPNG_PNG_INCLUDE_DIR=$DEPS_INSTALL_DIR/include \
          -DOPENGL_INCLUDE_DIR=/sysroot/usr/include \
          -DOPENGL_gl_LIBRARY=/sysroot/usr/lib/aarch64-linux-gnu/libGL.so \
          -DOPENGL_glu_LIBRARY=/sysroot/usr/lib/aarch64-linux-gnu/libGLU.so
        make install

    - name: Build Luanti
      run: |
        cd luanti
        cmake . -B build \
          -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/aarch64-linux-gnu.cmake \
          -DENABLE_GETTEXT=OFF \
          -DENABLE_LUAJIT=ON \
          -DENABLE_SOUND=ON \
          -DENABLE_CURL=ON \
          -DENABLE_FREETYPE=ON \
          -DBUILD_SERVER=OFF \
          -DBUILD_CLIENT=ON \
          -DVERSION_EXTRA=RPI5-STATIC \
          -DCMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/deps/install \
          -DCMAKE_EXE_LINKER_FLAGS="-static -static-libgcc -static-libstdc++" \
          -DIrrlicht_INCLUDE_DIR=$GITHUB_WORKSPACE/deps/install/include \
          -DIrrlicht_LIBRARY=$GITHUB_WORKSPACE/deps/install/lib/libIrrlicht.a \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
        cmake --build build -j$(nproc)

    - name: Verify binary architecture
      run: |
        file luanti/build/bin/luanti
        # Should output: ELF 64-bit LSB executable, ARM aarch64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: luanti-rpi5-static
        path: luanti/build/bin/luanti
